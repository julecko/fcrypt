# File format V1

## High-level Overview

An `.enc` file contains:

1. A fixed header (magic + version)
2. A password-derived salt
3. A secretstream header
4. Encrypted data chunks

All file data after the header is **authenticated and encrypted**.

## File Layout (Binary)

```
+----------------+----------------+----------------------+-------------------------+
| Magic (4B)     | Version (1B)   | Salt (SALT_SIZE)    | Stream Header (HEADER) |
+----------------+----------------+----------------------+-------------------------+
| Encrypted stream data (chunks, authenticated, final-tagged)              |
+---------------------------------------------------------------------------+
```

## Field Description

### Magic

- **Size:** 4 bytes
- **Value:** `"FCRT"`
- **Purpose:** File type identification

Used to quickly reject invalid or corrupted files.

### Version

- **Size:** 1 byte
- **Current value:** `0x01`
- **Purpose:** Forward compatibility

Future versions may extend or modify the format while preserving backward compatibility.

### Salt

- **Size:** `crypto_pwhash_SALTBYTES` (currently 16 bytes)
- **Purpose:** Password key derivation

A random salt is generated per file and used with `crypto_pwhash()` (Argon2id)
to derive the encryption key from the user password.

This prevents:
- Rainbow table attacks
- Key reuse across files

### Secretstream Header

- **Size:** `crypto_secretstream_xchacha20poly1305_HEADERBYTES`
- **Purpose:** Stream initialization

Generated by `crypto_secretstream_xchacha20poly1305_init_push()`.
It contains the nonce and internal parameters required to decrypt the stream.

The header is **not secret**, but must be authenticated and preserved.

## Encrypted Payload

- Encrypted using `crypto_secretstream_xchacha20poly1305`
- Processed in fixed-size chunks
- Each chunk includes authentication data
- The final chunk is marked with `TAG_FINAL`

## Error Handling & Validation

During decryption, the file is rejected if:

- Magic does not match
- Version is unsupported
- Header fields are missing or incomplete
- Authentication fails
- Final tag is missing or malformed

No partial plaintext is ever returned on failure.

## Design Goals

- Simple binary format
- Strong cryptographic guarantees
- Safe streaming for large files
- Explicit versioning
- Minimal metadata leakage